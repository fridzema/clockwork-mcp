---
description: Detect N+1 query patterns in recent requests
---

Use the `detect_n_plus_one` MCP tool to find N+1 query patterns.

## Scope Options

By default, analyzes only the latest request. Use these options to analyze multiple requests:

- `count`: Number of recent HTTP requests (e.g., `count: 10`)
- `since`: Time duration to look back (e.g., `since: "1h"`, `since: "30m"`, `since: "2d"`)
- `all`: Analyze all available requests (max 100)
- `uri`: Filter by URI pattern (e.g., `uri: "/api/users"`)
- `requestId`: Analyze specific request by ID

Examples:
- Latest request only: `detect_n_plus_one` (no scope params)
- Last 10 requests: `detect_n_plus_one` with `count: 10`
- Last hour: `detect_n_plus_one` with `since: "1h"`
- Specific endpoint: `detect_n_plus_one` with `count: 20, uri: "/api/orders"`

## Output Format

For single request:

## N+1 Query Detection

Found N potential N+1 patterns in request [METHOD] /uri/path

### Pattern 1: X occurrences
```sql
SELECT * FROM table WHERE id = ?
```
**Fix:** Use eager loading with `->with('relation')` or `->load('relation')`

For multiple requests:

## N+1 Query Detection - Last N Requests

Analyzed N requests, found M patterns in K requests

### Pattern 1: X total occurrences (avg Y/request)
```sql
SELECT * FROM posts WHERE user_id = ?
```
Affected requests:
- GET /api/users (15 occurrences)
- GET /api/dashboard (8 occurrences)
- GET /api/profile (5 occurrences)

**Fix:** `User::with('posts')`

### Pattern 2: Y total occurrences
```sql
SELECT * FROM comments WHERE post_id = ?
```
Affected requests:
- GET /api/posts (22 occurrences)

**Fix:** `Post::with('comments')`

## How to Fix N+1 Queries

In your controller or query:
```php
// Before (N+1)
$users = User::all();
foreach ($users as $user) {
    echo $user->posts; // Triggers query for each user
}

// After (eager loaded)
$users = User::with('posts')->get();
foreach ($users as $user) {
    echo $user->posts; // No additional queries
}
```

If no N+1 patterns are found:

## N+1 Query Detection

No N+1 patterns detected.
